<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:utext="${title}"></title>
    <link href="../static/css/evaluation/evaluation.css" th:href="@{/css/evaluation/evaluation.css}" rel="stylesheet"/>
    <link href="../static/css/main.css" th:href="@{/css/main.css}" rel="stylesheet"/>

    <script src="http://cdn.jsdelivr.net/webjars/jquery/2.1.4/jquery.min.js"
            th:src="@{http://cdn.jsdelivr.net/webjars/jquery/2.1.4/jquery.min.js}"></script>

</head>

<body id="bod">
<script>
    function fullScreenOn(){
           document.getElementById("butToFullScreen").style.display="none";
            document.getElementById("bod").webkitRequestFullscreen();
         //   document.getElementById("push").style.display="block";
 }
</script>
<center><button id="butToFullScreen" onclick="fullScreenOn()">FULLSCREEN</button></center>

<div id="logo">
    <image src='/img/logo.jpg' width="100%" height="100%"/>
</div>
<div id="container" class="container" display = 'none'>
    <div th:if="${errorMessage} != null" class="error"><span th:utext="${errorMessage}"></span></div>
    <!--   <div th:if="${not #lists.isEmpty(members)}">  -->
    <table th:if="${performance} != null">
        <tr>
            <th class="memberName" colspan="3"
                th:utext="${performance.member.lastName}+ '  ' + ${performance.member.name} + '  ' + ${performance.member.secondName}">
                Member
            </th>
        </tr>

        <tr>
            <th class="performanceName" colspan="3" th:utext="${performance.performanceName}">Performance</th>
        </tr>
        <tr>
            <th class="officeName" colspan="3" th:utext="${performance.member.office}">Office</th>
        </tr>

        <form id="evaluateWrapper" name='f' th:action="@{/evaluation/evaluate}" method='POST'
              th:object="${evaluateWrapper}">
            <tr>
                <td class="withoutBackground" colspan="3"><input type="hidden" id="performanceId" name='performanceId'
                                                                 th:value="${performance.performanceId}"
                                                                 required></td>
            </tr>


            <tr th:each="evaluate, stat : ${evaluateWrapper.evaluateList}">

                <td class="withoutBackground" hidden>
                    <input hidden th:name="${evaluate.id}"

                           th:value="${evaluate.id}" th:field="*{evaluateList[__${stat.index}__].id}"/>
                </td>
                <th class="withoutBackground" th:utext="${evaluate.name}" th:id="${evaluate.name}"></th>
                <td class="buttonContainer">
                    <button type="button" th:class="button + ${evaluate.id}"
                            th:utext="#{label.one}"
                            th:onclick="'setMark(\'' + ${evaluate.id} + '\',1);'">
                        1
                    </button>
                    <button type="button" th:class="button + ${evaluate.id}"
                            th:utext="#{label.two}"
                            th:onclick="'setMark(\'' + ${evaluate.id} + '\',2);'">
                        2
                    </button>
                    <button type="button" th:class="button + ${evaluate.id}"
                            th:utext="#{label.three}"
                            th:onclick="'setMark(\'' + ${evaluate.id} + '\',3);'">
                        3
                    </button>
                    <button type="button" th:class="button + ${evaluate.id}"
                            th:utext="#{label.four}"
                            th:onclick="'setMark(\'' + ${evaluate.id} + '\',4);'">
                        4
                    </button>
                    <button type="button" th:class="button + ${evaluate.id}"
                            th:utext="#{label.five}"
                            th:onclick="'setMark(\'' + ${evaluate.id} + '\',5);'">
                        5
                    </button>


                    <input hidden th:name="${evaluate.value}" class="mark"
                           th:id="${evaluate.id}"
                           th:value="${evaluate.value}" th:field="*{evaluateList[__${stat.index}__].value}"/>
                </td>


            </tr>
            <tr>
                <td hidden colspan="3" class="summaryValue"
                    th:id="summaryValue">0
                </td>
            </tr>
            <tr>
                <td class="submitButton" colspan="3">
                    <button type="submit" th:id="buttonSummaryValue" th:utext="0"
                            class="btn btn-default orange-circle-button">Save
                    </button>
                </td>
            </tr>

        </form>
    </table>
</div>
<script th:inline="javascript">


    function setMark(evaluateId, val){

   //Делаем стиль всех 5 кнопок категории, которой выставлена оценка, обычным
   var elements = document.getElementsByClassName(this.event.srcElement.className);
    for(var i=0; i<elements.length; i++) {
            elements[i].style.background = "#4CAF50";
        }
   //Выделяем нажатую кнопку
    var element = this.event.srcElement;
     element.style.background = "#FFAAAA";

    //Устанавливаем оценку по выбранному критерю в скрытое поле
    var eval = document.getElementById(evaluateId);
    eval.value=val;

    //Обновление общей оценки
    var elements = document.getElementsByClassName("mark");
    var summary = document.getElementById("summaryValue");
    summary.innerHTML="0";
        for(var i=0; i<elements.length; i++) {
         summary.innerHTML= parseInt(summary.innerHTML) + parseInt(elements[i].value);
        }
        document.getElementById("buttonSummaryValue").innerHTML=summary.innerHTML;
    }

$(document).ready(function() {
    document.getElementById("logo").style.display = 'block';
    document.getElementById("container").style.display = 'none';
    var errorMessage = /*[[${errorMessage}]]*/ 'Sebastian';
    if(errorMessage!=null){
        document.getElementById("buttonSummaryValue").disabled=true;
    }
    online();
});
    function online(){
	    setInterval(()=> isPerformanceNew(), 10000)
	}


     function isPerformanceNew(){
     var performanceId = "${performance.performanceId}";
		 /*<![CDATA[*/
        var performanceId = /*[[${performance.performanceId}]]*/ 'Sebastian';
          /*]]>*/


		$.ajax({
			type: 'POST',
			url: "/evaluation/isPerformanceNew",
			data: ({performanceId:performanceId}),
			success: function(data){
		    console.log(data);
                var obj = jQuery.parseJSON(data);
		        if(obj.needToLoadNewPerformance==true){
        		window.location.href = "/evaluation";
        	    }
        	     if(obj.isNeedLogo==true){
        	     document.getElementById("logo").style.display = 'block';
                 document.getElementById("container").style.display = 'none';
        	    }
        	    if(obj.isNeedLogo==false){
        	     document.getElementById("logo").style.display = 'none';
                 document.getElementById("container").style.display = 'block';
        	    }

        	}
		});
     }

//Проверка на заполненность оценок перед отправкой формы)
jQuery("#evaluateWrapper").submit(function(e) {
         var elements = document.getElementsByClassName("mark");
    var count = 0;
    for(var i=0; i<elements.length; i++) {
            var tcell = elements[i].parentNode;
            tcell.style.background = "#AFCDE7";
            if(elements[i].value == "0"){
              tcell.style.background="#FF0000";
              count+=1;
            }
        }
if(count>0){
return false;
}else{
document.getElementById("buttonSummaryValue").disabled=true;
}

});





</script>

</body>
</html>